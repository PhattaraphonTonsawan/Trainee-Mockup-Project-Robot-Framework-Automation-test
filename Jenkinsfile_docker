pipeline {
    agent any

    triggers {
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏≤‡∏™‡∏±‡∏Å‡∏≠‡∏±‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ
        // 1. ‡∏£‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (Nightly Test)
        cron('0 0 * * *') 
        // 2. ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ Code ‡∏ó‡∏∏‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ
        // pollSCM('H/30 * * * *')
    }
    parameters {
        choice(name: 'BROWSER', choices: ['chrome', 'edge', 'firefox'], description: 'Select browser')
        string(name: 'INCLUDE_TAG', defaultValue: '', description: 'Specify tag to run (leave empty for all)')
    }
    stages {
        stage('Checkout & Setup') {
            steps { // <--- ‡πÉ‡∏™‡πà steps ‡∏Ñ‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡∏°‡∏≠
                echo 'Checking out source code...'
                
                script {
                    echo 'Setting up Virtual Environment'
                    // ‡πÉ‡∏ä‡πâ python -m venv ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
                    sh 'if not exist "venv" (python -m venv venv)'
                    
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å pip ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏ path ‡∏ï‡∏£‡∏á‡πÜ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£ call activate
                    // ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏£ upgrade pip ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
                    sh 'venv\Scripts\python -m pip install --upgrade pip'
                    sh 'venv\Scripts\pip install -r requirements.txt' 
                }
            }
        }
        
        stage('Execute Robot Test') { // ‡πÅ‡∏Å‡πâ‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î Excute -> Execute
            steps { // <--- ‡πÉ‡∏™‡πà steps ‡∏Ñ‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡∏°‡∏≠
                script {
                    echo "Running tests on browser: ${params.BROWSER}"
                    
                    // Check tag logic
                    def tagCommand = params.INCLUDE_TAG ? "-i ${params.INCLUDE_TAG}" : ""
                    
                    catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                        // ‡∏•‡∏ö --dryrun ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á
                        // ‡πÉ‡∏ä‡πâ call activate ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ & ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô session ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                        bat """
                            call venv\Scripts\activate
                            robot -d reports\results -v BROWSER:${params.BROWSER} ${tagCommand} .
                        """
                    }
                }
            }
        }
    }
    post {
        always {
            echo 'Publishing Robot Results...'
            step([
                $class: 'RobotPublisher',
                // ‡πÅ‡∏Å‡πâ path ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á robot -d ...
                outputPath: 'reports/results', 
                outputFileName: 'output.xml',
                reportFileName: 'report.html',
                logFileName: 'log.html',
                disableArchiveOutput: false,
                passThreshold: 100,
                unstableThreshold: 80,
                otherFiles: '*.png'
            ])
            
            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ cleanWs() ‡∏à‡∏∞‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏¥‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö‡∏á‡∏≤‡∏ô 
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏î‡∏π log ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á ‡πÉ‡∏´‡πâ comment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö
            //cleanWs() 
        }
        failure {
            echo 'üö® JOB FAILED! ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡∏°‡∏î‡πà‡∏ß‡∏ô!'
        }
        success {
            echo '‚úÖ JOB SUCCESS! ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!'
        }
    }
}