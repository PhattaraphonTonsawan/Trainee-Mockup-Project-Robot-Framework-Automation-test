pipeline {
    agent any

    triggers {
        // 1. ‡∏£‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (Nightly Test)
        cron('0 0 * * *') 
        // 2. ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ Code ‡∏ó‡∏∏‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ
        // pollSCM('H/30 * * * *')
    }
    
    parameters {
        choice(name: 'BROWSER', choices: ['chrome', 'edge', 'firefox'], description: 'Select browser')
        string(name: 'INCLUDE_TAG', defaultValue: '', description: 'Specify tag to run (leave empty for all)')
    }
    
    stages {
        stage('Checkout & Setup') {
            steps { 
                echo 'Checking out source code...'
                
                script {
                    echo 'Setting up Virtual Environment'
                    
                    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö venv ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏™‡∏°‡∏≠ ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                    sh '''
                        rm -rf venv
                        python3 -m venv venv
                        . venv/bin/activate
                        pip install --upgrade pip
                        pip install -r requirements.txt
                    '''
                }
            }
        }
        
        stage('Execute Robot Test') { 
            steps { 
                script {
                    echo "Patching Robot Code for Docker..."
                    
                    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤: ‡πÅ‡∏≠‡∏ö‡πÅ‡∏Å‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô Pipeline ‡∏ô‡∏µ‡πâ ---
                    // ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ '--incognito' ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ï‡∏¥‡∏° option ‡∏Ç‡∏≠‡∏á docker ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
                    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô 'tests/Keywords.robot' ‡πÄ‡∏õ‡πá‡∏ô path ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏°‡∏µ Keyword ‡∏ô‡∏±‡πâ‡∏ô
                    sh """
                        sed -i '/--incognito/a \\ \\ \\ \\ BuiltIn.Call Method    \${chrome_options}    add_argument    --no-sandbox\\n\\ \\ \\ \\ BuiltIn.Call Method    \${chrome_options}    add_argument    --disable-dev-shm-usage\\n\\ \\ \\ \\ BuiltIn.Call Method    \${chrome_options}    add_argument    --disable-gpu' keywords/common/common_web.resource
                    """
                    // --------------------------------------------------

                    // ‡∏£‡∏±‡∏ô‡πÄ‡∏ó‡∏™‡∏ï‡πå‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
                    echo "Running tests..."
                    catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                         sh """
                            . venv/bin/activate
                            robot -d reports/results -v BROWSER:${params.BROWSER} ${tagCommand} .
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'Publishing Robot Results...'
            step([
                $class: 'RobotPublisher',
                outputPath: 'reports/results', 
                outputFileName: 'output.xml',
                reportFileName: 'report.html',
                logFileName: 'log.html',
                disableArchiveOutput: false,
                passThreshold: 100,
                unstableThreshold: 80,
                otherFiles: '*.png'
            ])
            
            // ‡πÉ‡∏ô Docker ‡∏Ñ‡∏ß‡∏£ cleanWs() ‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
            cleanWs() 
        }
        failure {
            echo 'üö® JOB FAILED! ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡∏°‡∏î‡πà‡∏ß‡∏ô!'
        }
        success {
            echo '‚úÖ JOB SUCCESS! ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!'
        }
    }
}