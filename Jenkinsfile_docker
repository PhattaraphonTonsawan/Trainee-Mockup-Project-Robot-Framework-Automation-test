pipeline {
    agent any

    triggers {
        // 1. ‡∏£‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (Nightly Test)
        cron('0 0 * * *') 
        // 2. ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ Code ‡∏ó‡∏∏‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ
        // pollSCM('H/30 * * * *')
    }
    
    parameters {
        choice(name: 'BROWSER', choices: ['chrome', 'edge', 'firefox'], description: 'Select browser')
        string(name: 'INCLUDE_TAG', defaultValue: '', description: 'Specify tag to run (leave empty for all)')
    }
    
    stages {
        stage('Checkout & Setup') {
            steps { 
                echo 'Checking out source code...'
                
                script {
                    echo 'Setting up Virtual Environment'
                    
                    // --- ‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Logic ‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö Linux ---
                    // Windows ‡πÉ‡∏ä‡πâ: if not exist
                    // Linux ‡πÉ‡∏ä‡πâ: [ ! -d "venv" ]
                    sh '''
                        if [ ! -d "venv" ]; then
                            python3 -m venv venv
                        fi
                    '''

                    // --- ‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô path ‡∏à‡∏≤‡∏Å Scripts ‡πÄ‡∏õ‡πá‡∏ô bin ---
                    // Windows ‡πÄ‡∏Å‡πá‡∏ö python ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô venv\Scripts\
                    // Linux ‡πÄ‡∏Å‡πá‡∏ö python ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô venv/bin/
                    sh """
                        . venv/bin/activate
                        pip install --upgrade pip
                        pip install -r requirements.txt
                    """
                }
            }
        }
        
        stage('Execute Robot Test') { 
            steps { 
                script {
                    echo "Running tests on browser: ${params.BROWSER}"
                    
                    def tagCommand = params.INCLUDE_TAG ? "-i ${params.INCLUDE_TAG}" : ""
                    
                    catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                        // --- ‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 3: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô bat ‡πÄ‡∏õ‡πá‡∏ô sh ---
                        // Docker ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å bat ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ sh
                        sh """
                            . venv/bin/activate
                            # ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡πÉ‡∏ô Docker ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô‡πÅ‡∏ö‡∏ö Headless (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
                            # ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ Robot Code ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° argument ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                            robot -d reports/results -v BROWSER:${params.BROWSER} ${tagCommand} .
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'Publishing Robot Results...'
            step([
                $class: 'RobotPublisher',
                outputPath: 'reports/results', 
                outputFileName: 'output.xml',
                reportFileName: 'report.html',
                logFileName: 'log.html',
                disableArchiveOutput: false,
                passThreshold: 100,
                unstableThreshold: 80,
                otherFiles: '*.png'
            ])
            
            // ‡πÉ‡∏ô Docker ‡∏Ñ‡∏ß‡∏£ cleanWs() ‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
            cleanWs() 
        }
        failure {
            echo 'üö® JOB FAILED! ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡∏°‡∏î‡πà‡∏ß‡∏ô!'
        }
        success {
            echo '‚úÖ JOB SUCCESS! ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!'
        }
    }
}